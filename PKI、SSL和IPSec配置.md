# 实验前提

这里使用一个主机，一个虚拟机，一个是用户端，一个是服务器端。

用户端的IP为192.168.3.102，服务器的IP为192.168.3.113

用户端的系统为windows 10，服务器端的系统为WindowsServer 2019

#  SSL配置

## 查看ip地址

### 客户端ip

![image-20221231211447006](assets/image-20221231211447006.png)

### 服务器端ip

![image-20221228224341274](assets/image-20221228224341274.png)

## 安装配置IIS服务器

![](assets/image-20221228210718671.png)

配置服务器，打开IIS管理器

新建网站：

![image-20221228211821550](assets/image-20221228211821550.png)

配置网站：

![image-20221228212256648](assets/image-20221228212256648.png)

服务器的目录下放置index.html文件

![image-20221228221304686](assets/image-20221228221304686.png)

![image-20221228221556703](assets/image-20221228221556703.png)

使用浏览器浏览新建网站

![image-20221228221720928](assets/image-20221228221720928.png)

## 未启用SSL协议

抓包结果，可以看到明文数据

![image-20221228234547666](assets/image-20221228234547666.png)

# PKI

### 安装证书服务

进入服务器管理 安装证书服务

![image-20221230204103706](assets/image-20221230204103706.png)

加入域并且安装web服务器

![](assets/image-20221230204746521.png)

### 创建根证书

配置服务器证书信息

![image-20221230213749175](assets/image-20221230213749175.png)

![image-20221230213849092](assets/image-20221230213849092.png)

配置私钥加密算法，选择MD5或默认

![image-20221230214001380](assets/image-20221230214001380.png)

CA名称设置

![image-20221230214411942](assets/image-20221230214411942.png)

有效期设置：

![image-20221230214125086](assets/image-20221230214125086.png)

默认点击下一步

![image-20221230214340989](assets/image-20221230214340989.png)



Web服务器申请证书

![image-20221230214936974](assets/image-20221230214936974.png)

申请证书

![image-20221230233256556](assets/image-20221230233256556.png)

下一步输入输出文件目录

![image-20221230233344594](assets/image-20221230233344594.png)

### 创建服务器网站证书

在服务器输入http://192.168.3.113/certsrv/，进入证书申请服务，点击申请证书

![image-20221230233725086](assets/image-20221230233725086.png)

点击高级证书申请

![image-20221230233827832](assets/image-20221230233827832.png)

点击使用base64编码的CMC

![image-20221230233915979](assets/image-20221230233915979.png)

打开保存的证书文件，把里面内容复制粘贴进去，点击提交

![image-20221231001316473](assets/image-20221231001316473.png)

提交成功

![image-20221231002425543](assets/image-20221231002425543.png)

### 证书签发启用SSL

打开管理工具-证书颁发机构

![image-20221231002628199](assets/image-20221231002628199.png)

颁发证书：

挂起的申请右侧，选中申请右击所有任务--颁发

![](assets/image-20221231002827624.png)

通过颁发的证书可以看到证书已颁发

![image-20221231003101231](assets/image-20221231003101231.png)

### 证书安装

下载证书

访问http://localhost/certsrv/,查看挂起的证书申请的状态

![image-20221231003256794](assets/image-20221231003256794.png)

点击申请证书

![image-20221231003342921](assets/image-20221231003342921.png)

选择Base64编码，下载证书

![image-20221231003444666](assets/image-20221231003444666.png)

**IIS完成证书申请**

管理工具--IIS--选中服务器--在右侧双击进入服务器证书，点击右侧完成证书申请

![image-20221231003815005](assets/image-20221231003815005.png)

选择上面步骤保存的证书文件

![image-20221231004009334](assets/image-20221231004009334.png)

成功完成证书申请

![image-20221231004058868](assets/image-20221231004058868.png)



## 启用SSL协议

新建网站,选用创建的证书

![](assets/image-20221231155718858.png)

打开WireShark进行抓包分析

![image-20221231160106205](assets/image-20221231160106205.png)

![image-20221231161125552](assets/image-20221231161125552.png)

可以看到数据都经过了加密



# IPSec设置

## 创建IPSec规则

打开本地安全策略

首先要打开本地安全策略，可以通过以下几种方法打开
1、开始---运行---输入“secpol.msc”---回车
2、开通---控制面板---管理工具---本地安全策略

![image-20221231162019658](assets/image-20221231162019658.png)

 右击“IP安全策略，在本地机器 ”--->“管理IP筛选列表和筛选器操作”

![image-20221231162227972](assets/image-20221231162227972.png)



添加IP筛选器

![image-20221231162420502](assets/image-20221231162420502.png)

填写名称，点击添加

![](assets/image-20221231162709781.png)

点击下一步

![image-20221231162739389](assets/image-20221231162739389.png)



![image-20221231162814969](assets/image-20221231162814969.png)



选择一个特定的IP地址或子网

![image-20221231163051881](assets/image-20221231163051881.png)



目标IP地址设为“我的IP地址”

![image-20221231163228841](assets/image-20221231163228841.png)

IP协议类型-选择TCP协议

![image-20221231163342497](assets/image-20221231163342497.png)

IP协议端口-设置 从任意端口到端口8888

![image-20221231163539428](assets/image-20221231163539428.png)

完成IP筛选器向导

![image-20221231163627469](assets/image-20221231163627469.png)

完成创建IP筛选器

![image-20221231163803926](assets/image-20221231163803926.png)

切换到管理筛选器操作，点击添加

![image-20221231163905661](assets/image-20221231163905661.png)

打开筛选器操作向导，点击下一步

![image-20221231164014965](assets/image-20221231164014965.png)



填写名称，点击下一步

![image-20221231164109983](assets/image-20221231164109983.png)

由于本次是通过IPSec协议的设置来阻止通信，所以选择 阻止

![image-20221231164219921](assets/image-20221231164219921.png)

完成筛选器操作向导

![image-20221231164256093](assets/image-20221231164256093.png)



 右击“IP安全策略，在本地计算机 ”--->创建IP安全策略

![image-20221231164356232](assets/image-20221231164356232.png)

打开IP安全向导

![image-20221231164511782](assets/image-20221231164511782.png)

填写IP安全策略名称，点击下一步

![image-20221231164603592](assets/image-20221231164603592.png)

点击下一步

![image-20221231164650712](assets/image-20221231164650712.png)

完成IP安全策略向导

![image-20221231164803202](assets/image-20221231164803202.png)

在弹出新窗口，点击添加

![image-20221231164904249](assets/image-20221231164904249.png)



打开安全规则向导

![image-20221231164950174](assets/image-20221231164950174.png)

点击下一步

![image-20221231165031136](assets/image-20221231165031136.png)

默认直接下一步

![image-20221231165102644](assets/image-20221231165102644.png)

选择新建的IP筛选器

![image-20221231165154567](assets/image-20221231165154567.png)

选择新建的筛选器操作

![image-20221231165259061](assets/image-20221231165259061.png)

完成安全规则向导

![image-20221231165335470](assets/image-20221231165335470.png)

完成上述操作后，此时还没有指派策略

![image-20221231165725749](assets/image-20221231165725749.png)

## 服务器端配置IPSec

新建一个使用端口3389的网站(操作同上，过程略)

![](assets/image-20221231202049841.png)

访问情况：主机成功访问

![](assets/image-20221231202157714.png)

通过WireShark抓包分析，可以看到服务器端有响应

![image-20221231203711481](assets/image-20221231203711481.png)

### 服务器端

### 启用IPSec

右键点击“阻止ip访问”，选择“分配”

![](assets/image-20221231203856752.png)

客户端无法访问网站,证明IPSec配置有效

![image-20221231204648471](assets/image-20221231204648471.png)

## 客户端配置IPSec

新建一个使用端口3390的网站（过程同上）

配置IP安全策略、配置IP筛选器、配置筛选器操作（过程同上）

### 未启用IPSec

客户端未配置IPSec，服务器端成功访问网页

![image-20221231210050346](assets/image-20221231210050346.png)

使用WireShark抓包分析，可以看到客户端有响应

![image-20221231210437463](assets/image-20221231210437463.png)

### 启用IPSec

客户端启用IPSec配置

![image-20221231210708476](assets/image-20221231210708476.png)

访问网站

![image-20221231213324631](assets/image-20221231213324631.png)

抓包分析

![image-20221231210758138](assets/image-20221231210758138.png)

可以看到服务器端连续发了3个TCP请求包给客户端，客户端都没有响应，证明IPSec配置有效